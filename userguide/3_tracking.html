

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tracking configuration &mdash; Stytra 0.8.33 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Calibration" href="4_calibration.html" />
    <link rel="prev" title="User interface" href="2_interface.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #4987a7" >
          

          
            <a href="../index.html" class="icon icon-home"> Stytra
          

          
            
            <img src="../_static/logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.8.32
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/0_motivation.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/1_library_structure.html">The structure of Stytra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/2_stimulation_intro.html">Stimulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/3_tracking.html">Image acquisition and tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/4_closed_loop.html">Closed-loop stimuli design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/5_external_sync.html">Synchronizing stimulation with data acquisition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/6_hardware_list.html">Hardware description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/7_comparison.html">Comparison with existing software and limitations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/8_replication.html">Experiment replication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/9_references.html">References</a></li>
</ul>
<p class="caption"><span class="caption-text">User guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="0_install_guide.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="1_examples_gallery.html">Designing and running experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_interface.html">User interface</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tracking configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#freely-swimming-fish">Freely-swimming fish</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tracking-results">Tracking results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#embedded-fish">Embedded fish</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Tracking results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#replaying-the-camera-feed-to-refine-tracking">Replaying the camera feed to refine tracking</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="4_calibration.html">Calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_configuring_computer.html">Configuring a computer for Stytra experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="6_coordinate_systems.html">Coordinate systems in Stytra</a></li>
<li class="toctree-l1"><a class="reference internal" href="7_offline.html">Offline use of Stytra</a></li>
<li class="toctree-l1"><a class="reference internal" href="8_faqs.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../devdocs/0_module_desc.html">Module description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devdocs/1_pipelines.html">Implementation of image processing pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devdocs/2_triggering_intro.html">Triggering a Stytra protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devdocs/3_data_saving.html">Data and metadata saving</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devdocs/4_parameters_stytra.html">Parameters in stytra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devdocs/5_status_messages.html">Process status messages</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Stytra</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Tracking configuration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/userguide/3_tracking.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tracking-configuration">
<h1>Tracking configuration<a class="headerlink" href="#tracking-configuration" title="Permalink to this headline">¶</a></h1>
<p>Here are some tips to adjust tracking on your setup. If you have not done
that yet, you probably want to have a look at the
<a class="reference internal" href="2_interface.html#user-interface"><span class="std std-ref">User interface</span></a> description first. Remember to use the dropdown menu to</p>
<blockquote>
<div><p>display the diagnostic images from intermediate stages of the image
processing! That is the best way to ensure that all parameters are set
correctly.</p>
</div></blockquote>
<div class="section" id="freely-swimming-fish">
<span id="fishtracking"></span><h2>Freely-swimming fish<a class="headerlink" href="#freely-swimming-fish" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="../_images/freeswim_tracking.png"><img alt="freely-swimming tracking screenshot" class="align-center" src="../_images/freeswim_tracking.png" style="width: 575.1px; height: 313.2px;" /></a>
<ol class="arabic">
<li><p>Open the tracking settings window</p></li>
<li><p>Input the number of fish in the dish</p></li>
<li><p>Determine the parameters for background subtraction
bglearning_rate and bglearn_every. bglearning_rate specifies what is the
weight which is assigned to every new image in the background computation,</p>
<blockquote>
<div><p>from 0 (only the first frame acquired will be used at the background) to
1 (every new frame is set as the background). bglearn_every specifies
every how many frames a new image is used to compute background. This
should change</p>
</div></blockquote>
<p>Under the camera view, you can select the currently displayed image (raw for the )</p>
</li>
<li><p>Once you see the fish nicely, adjust the thresholded image,
so that the full fish, but nothing more, is white bgdif_threshold</p></li>
<li><p>Adjust the eye threshold so that the eyes and swim bladder are highlighted (by changing the display_processed parameter)
threshold_eyes</p></li>
<li><p>Adjust the target area:
look at the biggest_area plot, if the background is correctly subtracted and a fish is in the field of view,
the value should equal the current area of the fish. Choose a range that is comfortably around the current fish are</p></li>
<li><p>Adjust the tail length: the red line tracing the tail should not go over the actual tail.</p></li>
<li><p>If the fish jumps around too much, adjust the prediction uncertainty.</p></li>
</ol>
<div class="section" id="tracking-results">
<h3>Tracking results<a class="headerlink" href="#tracking-results" title="Permalink to this headline">¶</a></h3>
<p>A dataframe with position, orientation and tail shape data for each fish tracked.
Data per fish are prefixed with <code class="docutils literal notranslate"><span class="pre">fN_</span></code> where N is the number of the fish
(fish identities can change if they exit the field of view, cross or lose tracking)
<code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> are positions in camera coordinates, <code class="docutils literal notranslate"><span class="pre">theta</span></code> the direction of the tail of the fish
(to get the heading direction, add pi) and <code class="docutils literal notranslate"><span class="pre">theta_XX</span></code> the angles of the tail segments.
To get the position in the projector coordinates, if the camera to projector
mapping was properly calibrated <a class="reference internal" href="4_calibration.html#calibration"><span class="std std-ref">Calibration</span></a>,
use the <code class="docutils literal notranslate"><span class="pre">cam_to_proj</span></code> matrix from the calibrator (saved in the metadata.json file)</p>
</div>
</div>
<div class="section" id="embedded-fish">
<span id="tailtracking"></span><h2>Embedded fish<a class="headerlink" href="#embedded-fish" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>Ensure that the exposure time is not longer than 1.5 milliseconds, otherwise
the tracking will not be correct for fast tail movements</p></li>
<li><p>Open the tracking settings window</p></li>
<li><p>Invert the image if the tail is dark with respect to the background</p></li>
<li><p>Set the camera display to filtered and adjust clipping until the fish is the only
bright thing with respect to the background, which has to be completely black.</p></li>
<li><p>Make the image as small as possible (with image_scale) as long as the tail is mostly more than 3px wide
and filter it a bit (usually using filter_size=3)</p></li>
<li><p>Adjust the number of tail segments, around 30 is a good number. Usually, not more than 10 n_output_segments are required</p></li>
<li><p>Tap the dish or the stage so that fish flicks its tail, and ensure the that it is tracked correctly. There should be no breaks in the tail_sum plot, if there are, it is likely the tail length line is too long. You can use the replay function to ensure the whole movement is tracked smoothly</p></li>
<li><p>To ensure the tracking is correct, you can enable the plotting of the last bout in the windows</p></li>
</ol>
<div class="section" id="id1">
<h3>Tracking results<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>A dataframe with the columns: <code class="docutils literal notranslate"><span class="pre">tail_sum</span></code> - the total curvature of the fish tail, i.e. the angle between the first and last segment
and <code class="docutils literal notranslate"><span class="pre">theta_XX</span></code> - the angle of each tail segment</p>
</div>
</div>
<div class="section" id="replaying-the-camera-feed-to-refine-tracking">
<span id="replaying"></span><h2>Replaying the camera feed to refine tracking<a class="headerlink" href="#replaying-the-camera-feed-to-refine-tracking" title="Permalink to this headline">¶</a></h2>
<p>The replay functionality allows a frame-by-frame view of the camera feed during
a period of interest (e.g. a bout or a struggle).
After an interesting event happens and you can see it in the plot, pause the camera with the
pause button. Use the two gray bars in the plots, select the time-period of interest.
Then, enable the replay with the button underneath the camera, and unpause the camera feed.
Now, the selected slice of time is replayed, and the framerate of the replay can be adjusted in the
camera parameters. To go back to the live feed, toggle the replay button.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="4_calibration.html" class="btn btn-neutral float-right" title="Calibration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="2_interface.html" class="btn btn-neutral float-left" title="User interface" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Vilim Štih and Luigi Petrucco, @portugueslab

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>