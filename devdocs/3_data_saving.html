

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Data and metadata saving &mdash; Stytra 0.8.33 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Parameters in stytra" href="4_parameters_stytra.html" />
    <link rel="prev" title="Triggering a Stytra protocol" href="2_triggering_intro.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #4987a7" >
          

          
            <a href="../index.html" class="icon icon-home"> Stytra
          

          
            
            <img src="../_static/logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.8.32
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/0_motivation.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/1_library_structure.html">The structure of Stytra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/2_stimulation_intro.html">Stimulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/3_tracking.html">Image acquisition and tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/4_closed_loop.html">Closed-loop stimuli design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/5_external_sync.html">Synchronizing stimulation with data acquisition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/6_hardware_list.html">Hardware description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/7_comparison.html">Comparison with existing software and limitations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/8_replication.html">Experiment replication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/9_references.html">References</a></li>
</ul>
<p class="caption"><span class="caption-text">User guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userguide/0_install_guide.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userguide/1_examples_gallery.html">Designing and running experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userguide/2_interface.html">User interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userguide/3_tracking.html">Tracking configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userguide/4_calibration.html">Calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userguide/5_configuring_computer.html">Configuring a computer for Stytra experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userguide/6_coordinate_systems.html">Coordinate systems in Stytra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userguide/7_offline.html">Offline use of Stytra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userguide/8_faqs.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="0_module_desc.html">Module description</a></li>
<li class="toctree-l1"><a class="reference internal" href="1_pipelines.html">Implementation of image processing pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_triggering_intro.html">Triggering a Stytra protocol</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Data and metadata saving</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#implementation-notes">Implementation notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-stytra-for-updating-external-database">Configuring Stytra for updating external database:</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="4_parameters_stytra.html">Parameters in stytra</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_status_messages.html">Process status messages</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Stytra</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Data and metadata saving</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/devdocs/3_data_saving.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="data-and-metadata-saving">
<h1>Data and metadata saving<a class="headerlink" href="#data-and-metadata-saving" title="Permalink to this headline">¶</a></h1>
<p>The design of Stytra encourages automatic data management. A dedicated <code class="xref py py-class docutils literal notranslate"><span class="pre">DataCollector</span></code> object is used to log the metadata about the experiment. Parameters from the entire program are appended to a single hierarchical parameter tree, which is saved at the end of the experiment. Quantities in the tree can come from different sources. Firstly, parameters can be added at any point in the code. For example, at every run the current version number of Stytra and git commit are detected and saved, together with the versions of the dependencies. Secondly, many of the key objects of Stytra (tracking nodes, display and camera controllers…) are parametrized though a custom parameters package (<a class="reference internal" href="4_parameters_stytra.html#parameters"><span class="std std-ref">lightparam</span></a>). When constructing them, one needs to pass the parameter tree that collects the data. This ensures that all quantities needed to replicate the experiment are collected within the metadata file. Finally, dedicated parametrized objects can be used to manually input metadata concerning the animal (age, genotype, etc.) or the experiment (setup, session, etc.). These classes can be customized to automatically include lab-specific metadata options, such as setup identifiers or animal lines (examples for this customization are provided in the documentation).</p>
<p>Various logs accompanying the experiment run (state of the stimuli, the raw tracking variables and the estimated state of the fish) are saved as tabular data. The supported data formats are CSV, HDF5 and Feather, but others could be added as long as they provide an interface to the Pandas library. To demonstrate the convenience of the data and metadata saving methods of Stytra, we made <a class="reference external" href="https://zenodo.org/record/1692080">example data</a> available together with <a class="reference external" href="https://github.com/portugueslab/example_stytra_analysis">Jupyter notebooks</a> for the analyses that can reproduce the figures in this paper. Finally, a central experiment database can be connected to keep track of all the experiments in a lab or institute, as described below.</p>
<div class="section" id="implementation-notes">
<h2>Implementation notes<a class="headerlink" href="#implementation-notes" title="Permalink to this headline">¶</a></h2>
<p>All streaming data (tracking, stimulus state) is collected by subclasses of the <code class="xref py py-class docutils literal notranslate"><span class="pre">Accumulator</span></code>
Accumulators collect named tuples of data and timing of data points. If the data format changes, the accumulator resets.</p>
<p>All other data (animal metadata, configuration information, GUI state etc. is collected inside the Experiment class via tha <code class="xref py py-class docutils literal notranslate"><span class="pre">DataCollector</span></code></p>
</div>
<div class="section" id="configuring-stytra-for-updating-external-database">
<h2>Configuring Stytra for updating external database:<a class="headerlink" href="#configuring-stytra-for-updating-external-database" title="Permalink to this headline">¶</a></h2>
<p>In addition to the JSON file, the metadata can be saved to a database, such as MongoDB.
For this, an appropriate database class has to be created and
passed to the Stytra class. This example uses PyMongo</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">stytra.utilities</span> <span class="kn">import</span> <span class="n">Database</span><span class="p">,</span> <span class="n">prepare_json</span>
<span class="kn">import</span> <span class="nn">pymongo</span>


<span class="k">class</span> <span class="nc">PortuguesDatabase</span><span class="p">(</span><span class="n">Database</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># in the next line you have to put in the IP address and port of the</span>
        <span class="c1"># MongoDB instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="s2">&quot;mongodb://192.???.???.???:????&quot;</span><span class="p">)</span>
        <span class="c1"># the database and collection are created in MongoDB before</span>
        <span class="c1"># the first use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">experiments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;experiments&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">insert_experiment_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Puts a record of the experiment in the default lab MongoDB database</span>

<span class="sd">        :param exp_dict: a dictionary from the experiment data collector</span>
<span class="sd">        :return: the database id of the inserted item</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># we use the prepare_json function to clean the dictionary</span>
        <span class="c1"># before inserting into the database</span>

        <span class="n">db_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span>
            <span class="n">prepare_json</span><span class="p">(</span><span class="n">exp_dict</span><span class="p">,</span> <span class="n">eliminate_df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">inserted_id</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">db_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="4_parameters_stytra.html" class="btn btn-neutral float-right" title="Parameters in stytra" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="2_triggering_intro.html" class="btn btn-neutral float-left" title="Triggering a Stytra protocol" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Vilim Štih and Luigi Petrucco, @portugueslab

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>